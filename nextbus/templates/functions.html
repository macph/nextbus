{# Functions for templates #}

{# Replaces header with search functionality #}
{% macro add_search_bar() %}
<header class="header">
    <a class="header__home" href="{{ url_for('page.index') }}">
        <!--<img src="{{ url_for('static', filename='img/bus-white.svg') }}" width="42px" alt="">-->
        <span>nextbus</span>
    </a>
    <a id="header-search-button" class="header__right">
        <span>Search</span>
    </a>
</header>
<div id="header-search-bar" class="search-bar">
    <form class="search-form search-bar__form" action="{{ g.action }}" method="post" name="search">
        {% set aria = {'aria-label': 'Find a bus stop'} %}
        {{ g.form.hidden_tag() }}
        {{ g.form.search_query(placeholder="Find a bus stop...", id='search-form', required=g.form.search_query.flags.required, **aria) }}
        {{ g.form.submit_query(id='submit-form') }}
    </form>
</div>
<script>
    addSearchBarEvents();
</script>
{% endmacro %}

{# Prints a list of groups, using <hr> to separate them #}
{% macro print_groups(list_groups) %}
{% set ctx = {'first': true} %}
{% for name, group in list_groups %}
{% if ctx.first %}
{% if ctx.update({'first': false}) %}{% endif %} {# Updates dictionary without printing anything #}
{% else %}
<hr/>
{% endif %}
{{ caller(name, group ) }}
{% endfor %}
{% endmacro %}

{# Prints a list using callers #}
{% macro print_list(items, class='') %}
<ul class="list {{ class }}">
    {% for i in items %}
    <li>{{ caller(i) }}</li>
    {% endfor %}
</ul>
{% endmacro %}

{# Prints a list of indices from dictionary #}
{% macro print_index(items) %}
<ul class="list-index">
    {% for name, _ in items|dictsort %}
    <li><a href="#{{ name }}"><span>{{ name }}</span></a></li>
    {% endfor %}
</ul>
{% endmacro %}

{# Prints the stop indicator #}
{% macro print_stop_indicator(stop, reverse=false) %}
<div class="indicator{{ ' indicator--reversed' if reverse else '' }} area-{{ stop.admin_area_ref }}">
    {% if stop.short_ind != '' %}
    <span>{{ stop.short_ind }}</span>
    {% elif stop.stop_type in ['BCT', 'BCS', 'GBCS', 'GCLS', 'GPBS'] %}
    <img src="{{ url_for('static', filename='img/bus-white.svg') }}" width="28px" alt="Bus stop">
    {% elif stop.stop_type in ['PLT', 'GTMU'] %}
    <img src="{{ url_for('static', filename='img/tram-white.svg') }}" width="28px" alt="Tram stop">
    {% endif %}
</div>
{%- endmacro %}


{% macro stop_full_name(stop) -%}
{{ stop.name }}{{ ' (%s)'|format(stop.indicator) if stop.indicator }}
{%- endmacro %}


{% macro print_list_stops_dist(list_stops, warning=true) -%}
{% if list_stops|length > 0 %}
<div class="list list-stops-services">
    {% for stop, distance in list_stops %}
    <div id="stop{{ stop.atco_code }}" class="item-stop-services">
        <div class="item-stop-services-row">
            <div class="item-stop-services-head item-stop-dist">
                {{ print_stop_indicator(stop) }}
                <div class="stop-label">{{ stop.name }}</div>
                <div class="stop-label stop-dist">{{ '%.0f m'|format(distance) }}</div>
            </div>
            <a href="{{ url_for('page.stop_atco', atco_code=stop.atco_code) }}" class="item-arrow"></a>
        </div>
        <div class="item-stop-services-content">
            <p>
                {% set pipe = joiner() %}
                {% if stop.street is not none %}{{ pipe() }}<strong>{{ stop.street }}</strong>{% endif %}<!--
             -->{% if stop.naptan_code is not none %}{{ pipe() }}SMS code <strong>{{ stop.naptan_code }}</strong>{% endif %}
            </p>
            <div class="heading-inline">
                <h2 class="stop-live-time">Retrieving live data...</h2>
                <span class="stop-live-countdown"></span>
            </div>
            <div class="stop-live-services"></div>
        </div>
    </div>
    {% endfor %}
</div>
{% elif warning %}
<p>No stops found.</p>
{% endif %}
{%- endmacro %}