{% import 'functions.html' as f %}
{% extends "base.html" %}
{% block title %}Stops by location{% endblock %}

{% block heading %}
<h1>Location ({{ coord[0] }}, {{ coord[1] }})</h1>
{% endblock %}

{% block content %}
<div class="heading-inline">
    <h2>Map</h2>
    <button id="buttonShowMap" class="small-button" type="button" onclick="" value="show">show</button>
</div>
<div class="google-maps-js" id="divMap"></div>
<h2>Stops</h2>
{% if list_stops|length > 0 %}
<div class="list list-stops-services">
    {% for stop, distance in list_stops %}
    <div id="stop{{ stop.atco_code }}" class="item-stop-services">
        <div class="item-stop-services-row">
            <div class="item-stop-services-head item-stop-dist">
                <div class="indicator stop-ind {{ f.stop_css_class(stop) }}"><span>{{ stop.get('short_ind', '') }}</span></div>
                <div class="stop-label">{{ stop['name'] }}</div>
                <div class="stop-label stop-dist">{{ '%.0f m'|format(distance) }}</div>
            </div>
            <a href="{{ url_for('page.stop_atco', atco_code=stop.atco_code) }}" class="item-arrow"></a>
        </div>
        <div class="item-stop-services-content">
            <p>
                {% set pipe = joiner() %}
                {% if stop.street is not none %}{{ pipe() }}<strong>{{ stop.get('street', '') }}</strong>{% endif %}<!--
             -->{% if stop.naptan_code is not none %}{{ pipe() }}SMS code <strong>{{ stop['naptan_code'] }}</strong>{% endif %}
            </p>
            <div class="heading-inline">
                <h2 class="stop-live-time">Retrieving live data...</h2>
                <span class="stop-live-countdown"></span>
            </div>
            <div class="stop-live-services"></div>
            <p><a href="{{ url_for('page.stop_atco', atco_code=stop.atco_code) }}">Link to stop</a></p>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<p>No stops found.</p>
{% endif %}
{{ f.resize_indicator("stop-ind") }}
<script>
    let lat = {{ coord[0] }}, long = {{ coord[1] }};
    let coords = {latitude: lat, longitude: long};
    let listStopsDist = {{ list_stops|tojson }};
    let listStops = listStopsDist.map(g => g[0]);

    var live = new ListLiveStops(
        "{{ url_for('page.stop_get_times') }}", listStops
    );
    live.init();

    var showButton = document.getElementById("buttonShowMap");
    var mapDiv = document.getElementById("divMap");
    var map = new MultiStopMap(mapDiv, coords, listStops, false, live.markerSelectStop);
    var elem = new AddMapElements(map, mapDiv, showButton, function() {
        let centreMarker = new google.maps.Marker({
            position: {lat: lat, lng: long},
            map: map.map,
            title: "Your location"
        });
        map.bounds.extend(newCoords);
        map.map.fitBounds(map.bounds);
    });
    elem.setupMap();
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC4z8yZknfpA57bRuTky5jC1rKtS_Phd-0&callback=map.setReady"></script>
{% endblock %}