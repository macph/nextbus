{% import 'functions.html' as f %}
{% extends "base.html" %}
{% block title %}Map{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
{% endblock %}

{% block outer_header %}
{{ f.add_search_bar() }}
{% endblock %}

{% block main %}
<main class="content" style="width: 100%; max-width: none;">
    <div id="map" class="map" style="height: 100%;"></div>
</main>
{% endblock %}

{% block script %}
<script>
    let mapElement = document.getElementById('map');

    function StopLayer(map, callback) {
        let self = this;
        this.map = map;
        this.currentLayer = null;
        this.callback = callback;
        this.BUS = "{{ url_for('static', filename='img/bus-white.svg') }}";
        this.TRAM = "{{ url_for('static', filename='img/tram-white.svg') }}";
        this.GET_URL = "{{ url_for('api.get_stops_within') }}";

        this.createLayer = function(stops) {
            let stopsGeo = new L.GeoJSON(stops, {
                pointToLayer: function(point, latLng) {
                    if (point.properties.indicator !== '') {
                        ind = '<span>' + point.properties.indicator + '</span>'
                    } else {
                        let src = (point.properties.stopType === 'PLT') ? self.TRAM : self.BUS;
                        ind = '<img src="' + src + '" width=28px>'
                    }
                    let area = 'area-' + point.properties.adminAreaRef;
                    let bearing = 'indicator-marker__arrow--' + point.properties.bearing;
                    let innerHTML = '<div class="indicator indicator-marker ' + area +
                        '"><div class="indicator-marker__arrow ' + bearing + '"></div>' + ind + '</div>';

                    let icon = L.divIcon({
                        className: 'marker',
                        iconSize: null,
                        html: innerHTML
                    });
                    let marker = L.marker(
                        latLng,
                        {
                            icon: icon,
                            title: point.properties.title,
                            alt: point.properties.indicator
                        }
                    );
                    // Move marker to front when mousing over
                    marker = marker.on('mouseover', function(event) {
                        this.setZIndexOffset(1000);
                    });
                    // Move marker to original z offset when mousing out
                    marker = marker.on('mouseout', function(event) {
                        this.setZIndexOffset(0);
                    });
                    // Add callback function to each marker with GeoJSON pointer object as argument
                    if (typeof self.callback !== 'undefined') {
                        marker = marker.on('click', function(event) {
                            self.callback(point)
                        });
                    }

                    return marker;
                }
            });

            return stopsGeo;
        };

        this.refreshLayer = function() {
            if (self.map.getZoom() < 16) {
                self.removeLayer();
                return;
            }

            let bounds = self.map.getBounds();
            let params = {
                north: bounds.getNorth(),
                east: bounds.getEast(),
                south: bounds.getSouth(),
                west: bounds.getWest()
            };
            let queryString = '?north=' + params.north +
                '&east=' + params.east +
                '&south=' + params.south +
                '&west=' + params.west;

            let request = new XMLHttpRequest();
            request.open('GET', self.GET_URL + queryString, true);
            request.addEventListener('load', function(event) {
                console.log('Recevied data');
                let data = JSON.parse(this.responseText);
                self.removeLayer();
                self.currentLayer = self.createLayer(data);
                console.log('Adding data and resizing indicators');
                self.currentLayer.addTo(self.map);
                resizeIndicator('indicator-marker');
            });
            request.send();
        };

        this.removeLayer = function() {
            if (self.currentLayer !== null) {
                console.log('Removing current layer');
                self.map.removeLayer(self.currentLayer);
                self.currentLayer = null;
            }
        }
    }

    let layer = L.tileLayer(
        'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}',
        {
            attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox.emerald',
            accessToken: '{{ config.get("MAPBOX_APP_TOKEN") }}'
        }
    )

    let map = L.map(mapElement.id, {
        zoom: {{ zoom }},
        center: L.latLng({{ latitude }}, {{ longitude }}),
        minZoom: 9,
        maxBounds: L.latLngBounds(
            L.latLng(49.5, -9.0),
            L.latLng(61.0, 2.5)
        )
    });
    layer.addTo(map);

    function TimeOut(timer) {
        let self = this;
        this.timer = timer;
        this.timeout = null;

        this.startTimer = function(callback) {
            self.timeout = setTimeout(callback, self.timer);
        }

        this.stopTimer = function() {
            if (self.timeout !== null) {
                clearTimeout(self.timeout);
            }
        }

        this.restartTimer = function(callback) {
            self.stopTimer();
            self.startTimer(callback);
        }
    }

    let markerGoToStop = function(point) {
        window.location.href = "{{ url_for('page.stop_atco', atco_code='') }}" + point.properties.atcoCode;
    }

    let getNewURL = function(map) {
        let center = map.getCenter();
        let zoom = map.getZoom();
        let newURL = "{{ url_for('page.show_map') }}" + center.lat + ',' + center.lng + ',' + zoom;

        return newURL;
    }

    let t = new TimeOut();
    let sl = new StopLayer(map, markerGoToStop);

    map.on('zoomstart', function(event) {
        sl.removeLayer();
    });

    map.on('zoomend', function(event) {
        history.replaceState(null, null, getNewURL(this));
        t.restartTimer(sl.refreshLayer);
    });

    map.on('moveend', function(event) {
        history.replaceState(null, null, getNewURL(this));
        t.restartTimer(sl.refreshLayer);
    });

    if (map.getZoom() >= 16) {
        sl.refreshLayer();
    }
</script>
{% endblock %}
