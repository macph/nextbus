{% import 'functions.html' as f %}
{% extends "base.html" %}
{% block title %}Map{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
{% endblock %}

{% block outer_header %}
{{ f.add_search_bar() }}
{% endblock %}

{% block main %}
<main class="content content--map">
    <div id="map" class="full-map"></div>
    <div class="map-panel">
        <div id="panel-content" class="map-panel__content">
            <div id="panel-heading-outer" class="heading heading--panel">
                <h1 id="panel-heading">Loading map...</h1>
            </div>
        </div>
        <div class="map-panel__footer">
            <footer class="footer footer--panel">
                <span class="footer__text">
                    &copy; Ewan Macpherson and data sources, 2017&ndash;18. <a href="{{ url_for('page.about') }}">About this website</a>
                </span>
            </footer>
        </div>
    </div>
</main>
{% endblock %}

{% block outer_footer %}
{% endblock %}

{% block script %}
<script>
    const BUS = "{{ url_for('static', filename='img/bus-white.svg') }}";
    const TRAM = "{{ url_for('static', filename='img/tram-white.svg') }}";
    let mapElement = document.getElementById('map');
    let panel = document.getElementById('panel-content');
    let headingOuter = document.getElementById('panel-heading-outer');

    function setMessage(panel, stops) {
        let heading = document.getElementById('panel-heading');
        if (heading === null) {
            headingOuter = document.createElement('div');
            headingOuter.className = 'heading heading--panel';
            headingOuter.id = 'panel-heading-outer';
            heading = document.createElement('h1');
            headingOuter.appendChild(heading);
            while (panel.firstChild) {
                panel.removeChild(panel.firstChild);
            }
            panel.appendChild(headingOuter);
        }

        if (stops === null) {
            heading.textContent = 'Zoom in to see stops';
        } else {
            let plural = (stops === 1) ? '' : 's';
            heading.textContent = stops + ' stop' + plural + ' on map';
        }
    }

    function detectIE() {
        // Detect IE use so can disable arrows - CSS transformations do not work properly
        // Credit: https://stackoverflow.com/a/21712356
        let ua = window.navigator.userAgent;
        return (ua.indexOf('MSIE ') > -1 || ua.indexOf('Trident/') > -1);
    }

    let activeStop = null;

    function createPanel(point) {
        if (activeStop !== null && typeof activeStop.stopLoop !== 'undefined') {
            activeStop.stopLoop();
        }

        let heading = document.createElement('div');
        heading.className = 'heading-stop';

        let stopInd = document.createElement('div');
        stopInd.className = 'indicator area-' + point.properties.adminAreaRef;
        let ind = null;
        if (point.properties.indicator !== '') {
           ind = document.createElement('span');
           ind.textContent = point.properties.indicator;
        } else if (point.properties.stopType === 'BCS' ||
                   point.properties.stopType === 'BCT') {
           ind = document.createElement('img');
           ind.src = BUS;
           ind.width = '28';
           ind.alt = 'Bus stop';
        } else if (point.properties.stopType === 'PLT') {
           ind = document.createElement('img');
           ind.src = TRAM;
           ind.width = '28';
           ind.alt = 'Tram stop';
        }
        stopInd.appendChild(ind);
        let stopHeading = document.createElement('h1');
        stopHeading.textContent = point.properties.name;
        heading.appendChild(stopInd);
        heading.appendChild(stopHeading);

        let headingOuter = document.createElement('div');
        headingOuter.className = 'heading heading--panel';
        headingOuter.id = 'panel-heading-outer';
        headingOuter.appendChild(heading);
        if (point.properties.bearing !== null) {
            let headingText = document.createElement('p');
            if (point.properties.street !== null) {
                headingText.innerHTML = '<strong>' + point.properties.street + '</strong>, ' +
                    point.properties.bearing + '-bound';
            } else {
                headingText.textContent = point.properties.bearing + '-bound';
            }
            headingOuter.appendChild(headingText);
        }

        let liveTimes = document.createElement('section');
        liveTimes.className = 'card card--panel';
        let liveHeading = document.createElement('div');
        liveHeading.className = 'heading-inline heading-inline--right';
        let liveHeadingTime = document.createElement('h2');
        liveHeadingTime.id = 'live-time';
        liveHeadingTime.textContent = 'Retrieving live data...';
        let liveHeadingCountdown = document.createElement('p');
        liveHeadingCountdown.id = 'live-countdown';
        liveHeading.appendChild(liveHeadingTime);
        liveHeading.appendChild(liveHeadingCountdown);
        let liveServices = document.createElement('div');
        liveServices.id = 'services';
        liveTimes.appendChild(liveHeading);
        liveTimes.appendChild(liveServices);

        let stopInfo = document.createElement('section');
        stopInfo.className = 'card card--panel';
        let infoHeading = document.createElement('h2');
        infoHeading.textContent = 'Stop information';
        let smsCode = document.createElement('p');
        smsCode.innerHTML = 'SMS code <strong>' + point.properties.naptanCode+ '</strong>';
        stopInfo.appendChild(infoHeading);
        stopInfo.appendChild(smsCode);

        while (panel.firstChild) {
            panel.removeChild(panel.firstChild);
        }
        panel.appendChild(headingOuter);
        resizeIndicator('indicator');
        panel.appendChild(liveTimes);
        panel.appendChild(stopInfo);

        activeStop = new LiveData(
            point.properties.atcoCode,
            point.properties.adminAreaRef,
            "{{ url_for('api.stop_get_times') }}",
            document.getElementById('services'),
            document.getElementById('live-time'),
            document.getElementById('live-countdown')
        );
        activeStop.startLoop();
    }

    function StopLayer(map, panel, callback) {
        let self = this;
        this.map = map;
        this.panel = panel;
        this.currentLayer = null;
        this.callback = callback;
        this.isIE = detectIE();
        this.GET_URL = "{{ url_for('api.get_stops_within') }}";

        this.createLayer = function(stops) {
            let stopsGeo = new L.GeoJSON(stops, {
                pointToLayer: function(point, latLng) {
                    let ind;
                    if (point.properties.indicator !== '') {
                        ind = '<span>' + point.properties.indicator + '</span>'
                    } else if (point.properties.stopType === 'BCS' ||
                               point.properties.stopType === 'BCT') {
                        ind = '<img src="' + BUS + '" width=28px>'
                    } else if (point.properties.stopType === 'PLT') {
                        ind = '<img src="' + TRAM + '" width=28px>'
                    } else {
                        ind = '';
                    }

                    let arrow;
                    if (!self.isIE) {
                        let bearing = 'indicator-marker__arrow--' + point.properties.bearing;
                        arrow = '<div class="indicator-marker__arrow ' + bearing + '"></div>';
                    } else {
                        arrow = '';
                    }

                    let area = 'area-' + point.properties.adminAreaRef;
                    let innerHTML = '<div class="indicator indicator-marker ' + area + '">' +
                        arrow + ind + '</div>';

                    let icon = L.divIcon({
                        className: 'marker',
                        iconSize: null,
                        html: innerHTML
                    });
                    let marker = L.marker(
                        latLng,
                        {
                            icon: icon,
                            title: point.properties.title,
                            alt: point.properties.indicator
                        }
                    );
                    // Move marker to front when mousing over
                    marker = marker.on('mouseover', function(event) {
                        this.setZIndexOffset(1000);
                    });
                    // Move marker to original z offset when mousing out
                    marker = marker.on('mouseout', function(event) {
                        this.setZIndexOffset(0);
                    });
                    // Add callback function to each marker with GeoJSON pointer object as argument
                    if (typeof self.callback !== 'undefined') {
                        marker = marker.on('click', function(event) {
                            self.callback(point)
                        });
                    }

                    return marker;
                }
            });

            return stopsGeo;
        };

        this.refreshLayer = function() {
            if (self.map.getZoom() < 16) {
                self.removeLayer();
                setMessage(self.panel, null);
                return;
            }

            let bounds = self.map.getBounds();
            let params = {
                north: bounds.getNorth(),
                east: bounds.getEast(),
                south: bounds.getSouth(),
                west: bounds.getWest()
            };
            let queryString = '?north=' + params.north +
                '&east=' + params.east +
                '&south=' + params.south +
                '&west=' + params.west;

            let request = new XMLHttpRequest();
            request.open('GET', self.GET_URL + queryString, true);
            request.addEventListener('load', function(event) {
                let data = JSON.parse(this.responseText);
                console.log('Received data', data);
                self.removeLayer();
                self.currentLayer = self.createLayer(data);
                setMessage(self.panel, data.features.length);
                console.log('Adding data and resizing indicators');
                self.currentLayer.addTo(self.map);
                resizeIndicator('indicator-marker');
            });
            request.send();
        };

        this.removeLayer = function() {
            if (self.currentLayer !== null) {
                console.log('Removing current layer');
                self.map.removeLayer(self.currentLayer);
                self.currentLayer = null;
            }
        }
    }

    let layer = L.tileLayer(
        'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}',
        {
            attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © ' +
                '<a href="http://mapbox.com">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox.emerald',
            accessToken: '{{ config.get("MAPBOX_APP_TOKEN") }}'
        }
    )

    let map = L.map(mapElement.id, {
        zoom: {{ zoom }},
        center: L.latLng({{ latitude }}, {{ longitude }}),
        minZoom: 9,
        maxBounds: L.latLngBounds(
            L.latLng(49.5, -9.0),
            L.latLng(61.0, 2.5)
        ),
        attributionControl: false
    });
    layer.addTo(map);

    function Delay(time) {
        let self = this;
        this.time = time;
        this.timeout = null;

        this.start = function(callback) {
            self.timeout = setTimeout(callback, self.time);
        }

        this.halt = function() {
            if (self.timeout !== null) {
                clearTimeout(self.timeout);
            }
        }

        this.restart = function(callback) {
            self.halt();
            self.start(callback);
        }
    }

    let getNewURL = function(map) {
        let center = map.getCenter();
        let zoom = map.getZoom();
        let newURL = "{{ url_for('page.show_map') }}" + center.lat + ',' + center.lng + ',' + zoom;

        return newURL;
    }

    let t = new Delay(250);
    let sl = new StopLayer(map, panel, createPanel);

    map.on('zoomstart', function(event) {
        sl.removeLayer();
    });

    map.on('zoomend', function(event) {
        history.replaceState(null, null, getNewURL(this));
        t.restart(sl.refreshLayer);
    });

    map.on('moveend', function(event) {
        history.replaceState(null, null, getNewURL(this));
        t.restart(sl.refreshLayer);
    });

    if (map.getZoom() >= 16) {
        sl.refreshLayer();
    } else {
        setMessage(panel, null);
    }
</script>
{% endblock %}
