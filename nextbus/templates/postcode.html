{% import 'functions.html' as f %}
{% extends "base.html" %}
{% block title %}Postcode {{ postcode.text }}{% endblock %}

{% block heading %}
{% set location = [postcode.text, postcode.district.name|d(postcode.admin_area.name)] %}
<h1>Postcode {{ location|join(', ') }}</h1>
{% endblock %}

{% block content %}
<div class="heading-inline">
    <h2>Map</h2>
    <button id="buttonShowMap" class="small-button" type="button" onclick="" value="show">show</button>
</div>
<div class="google-maps-js" id="divMap"></div>
<h2>Stops</h2>
{{ f.print_list_stops_dist(list_stops) }}

{{ f.resize_indicator("stop-ind") }}
<script>
    let lat = {{ postcode.latitude }}, long = {{ postcode.longitude }};
    let coords = {latitude: lat, longitude: long};
    let listStops = {{ stop_data|tojson }};

    var live = new ListLiveStops(
        "{{ url_for('api.stop_get_times') }}", listStops
    );
    live.init();

    var showButton = document.getElementById("buttonShowMap");
    var mapDiv = document.getElementById("divMap");
    var map = new MultiStopMap(mapDiv, coords, listStops, false, live.markerSelectStop);
    var elem = new AddMapElements(map, mapDiv, showButton, function() {
        let newCoords = {lat: lat, lng: long};
        let centreMarker = new google.maps.Marker({
            position: newCoords,
            map: map.map,
            title: "Your location"
        });
        map.bounds.extend(newCoords);
        map.map.fitBounds(map.bounds);
    });
    elem.setupMap();
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC4z8yZknfpA57bRuTky5jC1rKtS_Phd-0&callback=map.setReady"></script>
{% endblock %}