{% import 'functions.html' as f %}
{% extends "base.html" %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>
     <!-- Make sure you put this AFTER Leaflet's CSS -->
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
{% endblock %}

{% block title %}Postcode {{ postcode.text }}{% endblock %}

{% block heading %}
{% set location = [postcode.text, postcode.district.name|d(postcode.admin_area.name)] %}
<h1>Postcode {{ location|join(', ') }}</h1>
{% endblock %}

{% block content %}
<div class="heading-inline">
    <h2>Map</h2>
    <button id="buttonShowMap" class="small-button" type="button" onclick="" value="show">show</button>
</div>
<div class="google-maps-js" id="divMap"></div>
<h2>Stops</h2>
{{ f.print_list_stops_dist(list_stops) }}

{{ f.resize_indicator("stop-ind") }}
<script>
    let whichTransitionEvent = function(element) {
        var transitions = {
            'transition': 'transitionend',
            'OTransition': 'oTransitionEnd',
            'MozTransition': 'transitionend',
            'WebkitTransition': 'webkitTransitionEnd'
        };
        for (var t in transitions) {
            if (transitions.hasOwnProperty(t) && element.style[t] !== undefined) {
                return transitions[t];
            }
        }
    };

    let createMap = function(mapElement, token, stops, callback) {
        let layer = L.tileLayer(
            'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}',
            {
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
                maxZoom: 18,
                id: 'mapbox.emerald',
                accessToken: token
            }
        )

        let stopsGeo = new L.GeoJSON(stops, {
            pointToLayer: function(point, latLng) {
                let ind = point.properties.indicator;
                let area = 'area-color-' + point.properties.admin_area_ref;
                let bearing = ' indicator-marker__arrow--' + point.properties.bearing;
                let i = L.divIcon({
                    className: 'marker',
                    iconSize: null,
                    html: '<div class="indicator indicator-marker ' + area + '"><div class="indicator-marker__arrow' + bearing + '"></div><span>' + ind + '</span></div>'
                });
                return L.marker(
                    latLng,
                    {
                        icon: i,
                        title: point.properties.title,
                        alt: point.properties.indicator
                    }
                ).on('click', function(e) {
                    callback(point.properties.atco_code);
                });
            }
        });
        let bounds = stopsGeo.getBounds();

        let map = L.map(mapElement.id, {
            center: bounds.getCenter(),
            zoom: 18,
            minZoom: 9,
            maxBounds: L.latLngBounds(
                L.latLng(49.5, -9.0),
                L.latLng(61.0, 2.5)
            )
        });

        layer.addTo(map);
        stopsGeo.addTo(map);
        map.fitBounds(bounds, {padding: [50, 50]});
    }

    let lat = {{ postcode.latitude }}, long = {{ postcode.longitude }};
    let yourLocation = {
        type: 'Feature',
        geometry: {
            type: 'Point',
            coordinates: [long, lat]
        },
        properties: {
            title: 'Your location'
        }
    };

    let geojson = {{ data|tojson }};
    let listStops = geojson.features.map(f=>f.properties);

    let live = new ListLiveStops(
        "{{ url_for('api.stop_get_times') }}", listStops
    );
    live.init();

    let showButton = document.getElementById("buttonShowMap");
    let mapDiv = document.getElementById("divMap");

    let mapTransitionEnd = whichTransitionEvent(mapDiv);
    let mapTransitionCallback = function() {
        mapDiv.removeEventListener(mapTransitionEnd, mapTransitionCallback);
        showButton.textContent = "show";
        showButton.style.display = "none";

        createMap(mapDiv, '{{ config.get("MAPBOX_APP_TOKEN") }}', geojson, live.markerSelectStop);
        resizeInd("indicator-marker");
    }

    showButton.onclick = function() {
        showButton.textContent = "loading";
        mapDiv.style.paddingBottom = "56.25%";
        this.onclick = null;
        mapDiv.addEventListener(mapTransitionEnd, mapTransitionCallback);
    };
</script>
{% endblock %}