{% import 'functions.html' as f %}
{% extends 'base.html' %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
{% endblock %}

{% block title %}Postcode {{ postcode.text }}{% endblock %}

{% block outer_header %}
{{ f.add_search_bar() }}
{% endblock %}

{% block heading %}
<h1>Postcode {{ postcode.text }}, {{ postcode.district.name|d(postcode.admin_area.name) }} </h1>
{% endblock %}

{% block content %}
<div class="columns">
    <div class="column-1 column--empty"></div>
    <div class="column-3">
        <section class="card">
            <div class="heading-inline heading-inline--right">
                <h2>Map</h2>
                <button id="show-map-button">Show</button>
            </div>
            <div id="stop-map" class="stop-map"></div>
        </section>
        <section class="card">
            <h2>Stops nearby</h2>
            {% if list_stops|length > 0 %}
            {% call(s) f.print_list(list_stops, 'list--stops-wide') %}
            <a href="{{ url_for('page.stop_atco', atco_code=s.atco_code) }}" class="item item--stop--multiline">
                    <div class="item--stop">
                        {{ f.print_stop_indicator(s) }}
                        <div class="item__label">{{ s.name }}</div>
                        <div class="item__dist">{{ '%.0f m'|format(s.distance) }}</div>
                    </div>
                    {% if s.street %}
                    <p>{{ s.street }}</p>
                    {% endif %}
                </a>
            {% endcall %}
            {% else %}
            <p>No stops found within 500 metres.</p>
            {% endif %}
        </section>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    resizeIndicator('indicator');
</script>
<script>
    const BUS_SVG = "{{ url_for('static', filename='img/bus-white.svg') }}";
    const TRAM_SVG = "{{ url_for('static', filename='img/tram-white.svg') }}";
    let mapButton = document.getElementById('show-map-button');
    let map = document.getElementById('stop-map');

    let mapTransitionEnd = getTransitionEnd(map);
    let markerGoToStop = function(point) {
        window.location.href = "{{ url_for('page.stop_atco', atco_code='') }}" +
            point.properties.atcoCode;
    }
    let mapTransitionCallback = function() {
        map.removeEventListener(mapTransitionEnd, mapTransitionCallback);
        mapButton.style.display = 'none';
        addMap(
            "{{ config.get('MAPBOX_APP_TOKEN') }}",
            map.id,
            {{ data|tojson }},
            markerGoToStop
        );
        resizeIndicator('indicator-marker');
    }

    mapButton.addEventListener('click', function() {
        map.classList.add('stop-map--open--small');
        mapButton.textContent = 'Loading';
        map.addEventListener(mapTransitionEnd, mapTransitionCallback);
    });
</script>
{% endblock %}
