{% import 'functions.html' as f %}
{% extends 'base.html' %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
{% endblock %}

{% block title %}{{ f.stop_full_name(stop) }}{% endblock %}

{% block outer_header %}
{{ f.add_search_bar() }}
{% endblock %}

{% block heading %}
<nav>
    <ul class="breadcrumbs breadcrumbs--trailing">
        <li><a href="{{ url_for('page.list_regions') }}">All regions</a></li>
        <li>&sdot;&sdot;&sdot;</li>
        {% if stop.locality.district is not none %}
        <li><a href="{{ url_for('page.list_in_district', district_code=stop.locality.district.code) }}">{{ stop.locality.district.name }}</a></li>
        {% else %}
        <li><a href="{{ url_for('page.list_in_area', area_code=stop.locality.admin_area.code) }}">{{ stop.locality.admin_area.name }}</a></li>
        {% endif %}
        <li><a href="{{ url_for('page.list_in_locality', locality_code=stop.locality.code) }}">{{ stop.locality.name }}</a></li>
    </ul>
</nav>
<div class="heading-stop">
    {{ f.print_stop_indicator(stop) }}
    <h1>{{ stop.name }}</h1>
</div>
{% if stop.street or stop.bearing %}
{% set pipe = joiner() %}
<p>{% if stop.street is not none %}{{ pipe() }}<strong>{{ stop.street }}</strong>{% endif %}<!--
-->{% if stop.bearing is not none %}{{ pipe() }}{{ stop.bearing }}-bound{% endif %}</p>
{% endif %}
{% endblock %}

{% block content %}
<div class="columns">
    <div class="column-2">
        <section class="card card--min-height">
            <div class="heading-inline heading-inline--right">
                <h2 id="liveTime">Retrieving live data...</h2>
                <p id="liveCountdown"></p>
            </div>
            <div id="services"></div>
        </section>
        <section class="card">
            <div class="heading-inline heading-inline--right">
                <h2>Map</h2>
                <button id="show-map-button">Show</button>
            </div>
            <div id="stop-map" class="stop-map"></div>
        </section>
    </div>
    <div class="column-1">
        <section class="card card--aside">
            <h2>Stop information</h2>
            <p>
                {% set pipe = joiner() %}
                {% if stop.street is not none %}{{ pipe() }}<strong>{{ stop.street }}</strong>{% endif %}<!--
             -->{% if stop.crossing is not none and stop.crossing != stop.street %}{{ pipe() }}{{ stop.crossing }}{% endif %}<!--
             -->{% if stop.landmark is not none and stop.landmark != stop.crossing %}{{ pipe() }}{{ stop.landmark }}{% endif %}
            </p>
            <p>SMS code <strong>{{ stop.naptan_code}}</strong></p>
        </section>
        {% if stop.stop_area_ref is not none %}
        <section class="card card--aside">
            <h2>Other stops</h2>
            <p><a href="{{ url_for('page.stop_area', stop_area_code=stop.stop_area.code) }}">View all stops around {{ stop.stop_area.name }}</a></p>
        </section>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    resizeIndicator('indicator');
</script>
<script>
    let ld = new LiveData(
        "{{ stop.atco_code }}",
        "{{ stop.admin_area_ref }}",
        "{{ url_for('api.stop_get_times', atco_code='') }}",
        document.getElementById("services"),
        document.getElementById("liveTime"),
        document.getElementById("liveCountdown")
    )
    ld.startLoop();
</script>
<script>
    let mapButton = document.getElementById('show-map-button');
    let map = document.getElementById('stop-map');

    let mapTransitionEnd = getTransitionEnd(map);
    let mapTransitionCallback = function() {
        map.removeEventListener(mapTransitionEnd, mapTransitionCallback);
        mapButton.style.display = 'none';
        addMap(map, '{{ config.get("MAPBOX_APP_TOKEN") }}', {{ stop.to_geojson()|tojson }}, "{{ url_for('static', filename='img/bus-white.svg') }}", "{{ url_for('static', filename='img/tram-white.svg') }}");
        resizeIndicator('indicator-marker');
    }

    mapButton.addEventListener('click', function() {
        map.classList.add('stop-map--open--small');
        mapButton.textContent = 'Loading';
        map.addEventListener(mapTransitionEnd, mapTransitionCallback);
    });
</script>
{% endblock %}