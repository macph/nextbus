{% import 'functions.html' as f %}
{% extends 'base.html' %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>
     <!-- Make sure you put this AFTER Leaflet's CSS -->
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
{% endblock %}

{% block title %}{{ stop_area.name }}{% endblock %}

{% block nav %}
<ul class="breadcrumbs trailing">
    <li><a href="{{ url_for('page.list_regions') }}">All regions</a></li>
    <li><a href="{{ url_for('page.list_in_area', area_code=stop_area.admin_area.code) }}">{{ stop_area.admin_area.name }}</a></li>
    {% if stop_area.locality.district is not none %}
    <li><a href="{{ url_for('page.list_in_district', district_code=stop_area.locality.district.code) }}">{{ stop_area.locality.district.name }}</a></li>
    {% endif %}
    <li><a href="{{ url_for('page.list_in_locality', locality_code=stop_area.locality.code) }}">{{ stop_area.locality.name }}</a></li>
</ul>
{% endblock %}

{% block heading %}
<h1>{{ stop_area.name }}</h1>
{% endblock %}

{% block content %}
<div class="heading-inline">
    <h2>Map</h2>
    <button id="buttonShowMap" class="small-button" type="button" onclick="" value="show">show</button>
</div>
<div class="google-maps-js" id="divMap"></div>
<h2>Stops</h2>
{% if stop_area.stop_points|length > 0 %}
<div class="list list-stops-services">
    {% for stop in stop_area.stop_points %}
    <div id="stop{{ stop.atco_code }}" class="item-stop-services">
        <div class="item-stop-services-row">
            <div class="item-stop-services-head">
                {{ f.print_stop_indicator(stop) }}
                <div class="stop-label">{{ stop.name }}</div>
            </div>
            <a href="{{ url_for('page.stop_atco', atco_code=stop.atco_code) }}" class="item-arrow"></a>
        </div>
        <div class="item-stop-services-content">
            <p>
                {% set pipe = joiner() %}
                {% if stop.street is not none %}{{ pipe() }}<strong>{{ stop.street }}</strong>{% endif %}<!--
             -->{% if stop.naptan_code is not none %}{{ pipe() }}SMS code <strong>{{ stop.naptan_code }}</strong>{% endif %}
            </p>
            <div class="heading-inline">
                <h2 class="stop-live-time">Retrieving live data...</h2>
                <span class="stop-live-countdown"></span>
            </div>
            <div class="stop-live-services"></div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<p>No stops found.</p>
{% endif %}
{{ f.resize_indicator("stop-ind") }}
<script>
    let whichTransitionEvent = function(element) {
        var transitions = {
            'transition': 'transitionend',
            'OTransition': 'oTransitionEnd',
            'MozTransition': 'transitionend',
            'WebkitTransition': 'webkitTransitionEnd'
        };
        for (var t in transitions) {
            if (transitions.hasOwnProperty(t) && element.style[t] !== undefined) {
                return transitions[t];
            }
        }
    };

    let createMap = function(mapElement, token, stops, callback) {
        let layer = L.tileLayer(
            'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}',
            {
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
                maxZoom: 18,
                id: 'mapbox.emerald',
                accessToken: token
            }
        )

        let stopsGeo = new L.GeoJSON(stops, {
            pointToLayer: function(point, latLng) {
                let ind = point.properties.indicator;
                let area = 'area-color-' + point.properties.admin_area_ref;
                let bearing = ' indicator-marker__arrow--' + point.properties.bearing;
                let i = L.divIcon({
                    className: 'marker',
                    iconSize: null,
                    html: '<div class="indicator indicator-marker ' + area + '"><div class="indicator-marker__arrow' + bearing + '"></div><span>' + ind + '</span></div>'
                });
                return L.marker(
                    latLng,
                    {
                        icon: i,
                        title: point.properties.title,
                        alt: point.properties.indicator
                    }
                ).on('click', function(e) {
                    callback(point.properties.atco_code);
                });
            }
        });
        let bounds = stopsGeo.getBounds();

        let map = L.map(mapElement.id, {
            center: bounds.getCenter(),
            zoom: 18,
            minZoom: 9,
            maxBounds: L.latLngBounds(
                L.latLng(49.5, -9.0),
                L.latLng(61.0, 2.5)
            )
        });

        layer.addTo(map);
        stopsGeo.addTo(map);
        map.fitBounds(bounds, {padding: [24, 24]});
    }

    let area = {{ stop_area._asdict()|tojson }};
    let geojson = {{ data|tojson }};
    let listStops = geojson.features.map(f=>f.properties);

    let live = new ListLiveStops(
        "{{ url_for('api.stop_get_times') }}", listStops
    );
    live.init();

    let showButton = document.getElementById("buttonShowMap");
    let mapDiv = document.getElementById("divMap");

    let mapTransitionEnd = whichTransitionEvent(mapDiv);
    let mapTransitionCallback = function() {
        mapDiv.removeEventListener(mapTransitionEnd, mapTransitionCallback);
        showButton.textContent = "show";
        showButton.style.display = "none";

        createMap(mapDiv, '{{ config.get("MAPBOX_APP_TOKEN") }}', geojson, live.markerSelectStop);
        resizeInd("indicator-marker");
    }

    showButton.onclick = function() {
        showButton.textContent = "loading";
        mapDiv.style.paddingBottom = "56.25%";
        this.onclick = null;
        mapDiv.addEventListener(mapTransitionEnd, mapTransitionCallback);
    };
</script>
{% endblock %}